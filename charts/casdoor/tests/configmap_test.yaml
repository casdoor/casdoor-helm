suite: test configmap
templates:
  - configmap.yaml
tests:
  - it: should generate SQLite config by default
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: data["app.conf"]
          pattern: "driverName = sqlite"
      - matchRegex:
          path: data["app.conf"]
          pattern: "dataSourceName = file:casdoor.db\\?cache=shared"

  - it: should generate PostgreSQL config with lowercase driver
    set:
      database.driver: postgres
      database.host: postgresql-rw.database.svc.cluster.local
      database.port: 5432
      database.user: casdoor
      database.databaseName: casdoor
      database.password: test_password
      database.sslMode: disable
    asserts:
      - matchRegex:
          path: data["app.conf"]
          pattern: "driverName = postgres"
      - matchRegex:
          path: data["app.conf"]
          pattern: 'dataSourceName = "user=casdoor password=test_password host=postgresql-rw.database.svc.cluster.local port=5432 dbname=casdoor sslmode=disable"'

  - it: should generate PostgreSQL config with capitalized driver
    set:
      database.driver: Postgres
      database.host: postgresql-rw.database.svc.cluster.local
      database.port: 5432
      database.user: casdoor
      database.databaseName: casdoor
      database.password: test_password
      database.sslMode: disable
    asserts:
      - matchRegex:
          path: data["app.conf"]
          pattern: "driverName = postgres"
      - matchRegex:
          path: data["app.conf"]
          pattern: 'dataSourceName = "user=casdoor password=test_password host=postgresql-rw.database.svc.cluster.local port=5432 dbname=casdoor sslmode=disable"'

  - it: should generate PostgreSQL config with uppercase driver
    set:
      database.driver: POSTGRES
      database.host: postgresql-rw.database.svc.cluster.local
      database.port: 5432
      database.user: casdoor
      database.databaseName: casdoor
      database.password: test_password
      database.sslMode: disable
    asserts:
      - matchRegex:
          path: data["app.conf"]
          pattern: "driverName = postgres"
      - matchRegex:
          path: data["app.conf"]
          pattern: 'dataSourceName = "user=casdoor password=test_password host=postgresql-rw.database.svc.cluster.local port=5432 dbname=casdoor sslmode=disable"'

  - it: should generate MySQL config with lowercase driver
    set:
      database.driver: mysql
      database.host: mysql-host
      database.port: 3306
      database.user: testuser
      database.databaseName: testdb
      database.password: testpass
    asserts:
      - matchRegex:
          path: data["app.conf"]
          pattern: "driverName = mysql"
      - matchRegex:
          path: data["app.conf"]
          pattern: "dataSourceName = testuser:testpass@tcp\\(mysql-host:3306\\)/"

  - it: should generate MySQL config with capitalized driver
    set:
      database.driver: MySQL
      database.host: mysql-host
      database.port: 3306
      database.user: testuser
      database.databaseName: testdb
      database.password: testpass
    asserts:
      - matchRegex:
          path: data["app.conf"]
          pattern: "driverName = mysql"
      - matchRegex:
          path: data["app.conf"]
          pattern: "dataSourceName = testuser:testpass@tcp\\(mysql-host:3306\\)/"

  - it: should generate CockroachDB config
    set:
      database.driver: cockroachdb
      database.host: cockroach-host
      database.port: 26257
      database.user: testuser
      database.databaseName: testdb
      database.password: testpass
      database.sslMode: disable
    asserts:
      - matchRegex:
          path: data["app.conf"]
          pattern: "driverName = cockroachdb"
      - matchRegex:
          path: data["app.conf"]
          pattern: 'dataSourceName = "user=testuser password=testpass host=cockroach-host port=26257 dbname=testdb sslmode=disable serial_normalization=virtual_sequence"'

  - it: should use default port for PostgreSQL when port is empty
    set:
      database.driver: postgres
      database.host: postgresql-host
      database.user: testuser
      database.databaseName: testdb
      database.password: testpass
      database.sslMode: disable
    asserts:
      - matchRegex:
          path: data["app.conf"]
          pattern: "port=5432"

  - it: should use default port for MySQL when port is empty
    set:
      database.driver: mysql
      database.host: mysql-host
      database.user: testuser
      database.databaseName: testdb
      database.password: testpass
    asserts:
      - matchRegex:
          path: data["app.conf"]
          pattern: "mysql-host:3306"

  - it: should use default port for CockroachDB when port is empty
    set:
      database.driver: cockroachdb
      database.host: cockroach-host
      database.user: testuser
      database.databaseName: testdb
      database.password: testpass
      database.sslMode: disable
    asserts:
      - matchRegex:
          path: data["app.conf"]
          pattern: "port=26257"

  - it: should not create ConfigMap when configFromSecret is set
    set:
      configFromSecret: my-secret
    asserts:
      - hasDocuments:
          count: 0
